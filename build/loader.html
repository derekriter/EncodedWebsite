<!DOCTYPE html>
<html>
    <head>
        <title>Loading...</title>
        <link rel="shortcut icon" href="/logo.svg"/>
    </head>
    <body>
        <script id="enc-loader">
            async function getFile(name) {
                try {
                    const response = await fetch(name, {method: "GET"});
                    if(!response.ok) {
                        throw new Error(`${response.status} File not found<br/>${response.url}`);
                    }
                    
                    return response.text();
                }
                catch(err) {
                    return Promise.reject(err); 
                }
            }
            
            async function attachCSS(html, doc) {
                const prefix = "enc-loader-CSS:";
                
                if(html.indexOf(prefix) === -1) return;
                
                let requested = html.substring(html.indexOf(prefix) + prefix.length);
                if(requested.indexOf("\n") !== -1) requested = requested.substring(0, requested.indexOf("\n"));
                
                let targets = requested.split(" ");
                for(let t of targets) {
                    if(t === "") continue;
                    
                    let filename = t;
                    if(filename.indexOf(".") === -1) filename += ".enc";
                    else filename = filename.substring(0, filename.indexOf(".")) + ".enc" + filename.substring(filename.indexOf("."));
                    
                    try {
                        let resp = await getFile(filename);
                        
                        let elem = document.createElement("style");
                        elem.innerHTML = atob(resp);
                        
                        doc.head.appendChild(elem);
                    }
                    catch(err) {
                        return Promise.reject(err);
                    }
                };
            }
            async function attachJS(html, doc) {
                const prefix = "enc-loader-JS:";
                
                if(html.indexOf(prefix) === -1) return;
                
                let requested = html.substring(html.indexOf(prefix) + prefix.length);
                if(requested.indexOf("\n") !== -1) requested = requested.substring(0, requested.indexOf("\n"));
                
                let targets = requested.split(" ");
                for(let t of targets) {
                    if(t === "") continue;
                    
                    let filename = t;
                    if(filename.indexOf(".") === -1) filename += ".enc";
                    else filename = filename.substring(0, filename.indexOf(".")) + ".enc" + filename.substring(filename.indexOf("."));
                    
                    try {
                        let resp = await getFile(filename);
                        
                        let elem = document.createElement("script");
                        elem.innerHTML = atob(resp);
                        
                        doc.body.appendChild(elem);
                    }
                    catch(err) {
                        return Promise.reject(err);
                    }
                };
            }
            
            /*
            domain.com/             index.enc.html
            domain.com/?t=sub/      sub/index.enc.html
            */
            
            const params = new URLSearchParams(new URL(window.document.URL).search);
            let target = "/";
            
            if(params.has("t")) target = params.get("t");
            if(target.endsWith("/")) target += "index.enc.html";
            else if(target.indexOf(".") === -1) target += "/index.enc.html";
            
            getFile(target).then((raw) => {
                let file = atob(raw);
                let parser = new DOMParser();
                
                let proc = parser.parseFromString(file, "text/html");
                attachCSS(file, proc).then(() => {
                    document.documentElement.innerHTML = proc.documentElement.innerHTML;
                    attachJS(file, document).catch((err) => {
                        return Promise.reject(err);
                    });
                }).catch((err) => {
                    return Promise.reject(err);
                });
            }).catch((err) => {
                console.log(err);
            });
        </script>
    </body>
</html>
