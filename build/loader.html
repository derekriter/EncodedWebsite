<!DOCTYPE html>
<html>
    <head>
        <title>Loading...</title>
        <link rel="shortcut icon" href="/logo.svg">
    </head>
    <body>
        <script id="enc-loader">
            async function getFile(name) {
                try {
                    const response = await fetch(name, {method: "GET"});
                    if(!response.ok) {
                        throw new Error(`${response.status} File not found\n${response.url}`);
                    }
                    
                    return response.text();
                }
                catch(err) {
                    return Promise.reject(err); 
                }
            }
            
            function getEncodedName(name) {
                if(name.indexOf(".") === -1) name += ".enc";
                else name = name.substring(0, name.indexOf(".")) + ".enc" + name.substring(name.indexOf("."));
                
                return name;
            }
            async function insertTemplates(html) {
                const prefix = "$$";
                let modded = html;
                let cache = {};
                
                let start;
                let moddedStart = 0;
                while((start = html.indexOf(prefix)) !== -1) {
                    moddedStart += start;
                    let req = html.substring(start + prefix.length);
                    
                    let end = req.indexOf("\n");
                    if(end !== -1) req = req.substring(0, end);
                    
                    let content;
                    if(cache.hasOwnProperty(req)) {
                        content = cache[req];
                    }
                    else {
                        let filename = getEncodedName(req);
                        try {
                            content = atob(await getFile(filename));
                            cache[req] = content;
                        }
                        catch(err) {
                            return Promise.reject(err);
                        }
                    }
                    
                    modded = modded.substring(0, moddedStart) + content + modded.substring(moddedStart + prefix.length + end + 1);
                    
                    moddedStart += content.length;
                    html = html.substring(start + prefix.length + end + 1);
                }
                
                return Promise.resolve(modded);
            }
            async function attachCSS(html, doc) {
                const prefix = "enc-loader-CSS:";
                
                if(html.indexOf(prefix) === -1) return;
                
                let requested = html.substring(html.indexOf(prefix) + prefix.length);
                if(requested.indexOf("\n") !== -1) requested = requested.substring(0, requested.indexOf("\n"));
                
                let targets = requested.split(" ");
                for(let t of targets) {
                    if(t === "") continue;
                    
                    let filename = getEncodedName(t);
                    
                    try {
                        let resp = await getFile(filename);
                        
                        let elem = document.createElement("style");
                        elem.innerHTML = atob(resp);
                        
                        doc.head.appendChild(elem);
                    }
                    catch(err) {
                        return Promise.reject(err);
                    }
                };
            }
            async function attachJS(html, doc) {
                const prefix = "enc-loader-JS:";
                
                if(html.indexOf(prefix) === -1) return;
                
                let requested = html.substring(html.indexOf(prefix) + prefix.length);
                if(requested.indexOf("\n") !== -1) requested = requested.substring(0, requested.indexOf("\n"));
                
                let targets = requested.split(" ");
                for(let t of targets) {
                    if(t === "") continue;
                    
                    let filename = getEncodedName(t);
                    
                    try {
                        let resp = await getFile(filename);
                        
                        let elem = document.createElement("script");
                        elem.innerHTML = atob(resp);
                        
                        doc.body.appendChild(elem);
                    }
                    catch(err) {
                        return Promise.reject(err);
                    }
                };
            }
            
            /*
            domain.com/             index.enc.html
            domain.com/?t=sub/      sub/index.enc.html
            */
            
            const params = new URLSearchParams(new URL(window.document.URL).search);
            let target = "/";
            
            if(params.has("t")) target = params.get("t");
            if(target.endsWith("/")) target += "index.enc.html";
            else if(target.indexOf(".") === -1) target += "/index.enc.html";
            
            getFile(target).then((raw) => {
                let file = atob(raw);
                
                insertTemplates(file).then((modded) => {
                    // console.log(modded);
                    
                    file = modded;
                    let loaded = new DOMParser().parseFromString(file, "text/html");
                    
                    attachCSS(file, loaded).then(() => {
                        document.documentElement.innerHTML = loaded.documentElement.innerHTML;
                        
                        attachJS(file, document).catch((err) => {
                            return Promise.reject(err);
                        });
                    }).catch((err) => {
                        return Promise.reject(err);
                    });
                }).catch((err) => {
                    return Promise.reject(err);
                });
            }).catch((err) => {
                console.log(err);
            });
        </script>
    </body>
</html>
